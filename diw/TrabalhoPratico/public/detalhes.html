<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Detalhes do Álbum</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/detalhes.css">
</head>

<body>
    <header class="topbar">
        <button id="menuHamburger" class="hamburger-btn">
            <i class="fas fa-bars"></i>
        </button>

        <div class="actions">
            <div class="actions">
                <a href="login.html" id="btnAuth" class="nav-link btn btn-sm">Login</a>
                <span id="msgOla" class="text-white ms-2"></span>

                <input type="text" id="campoBusca" placeholder="Buscar" oninput="pesquisar()" style="display: none;">
                <button id="btnBusca"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>

        </div>

        <!-- <div class="actions">
            <a href="login.html" id="btnAuth" class="nav-link btn btn-sm">Login</a>
            <button id="btnBusca"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div> -->
    </header>

    <nav class="sidebar d-flex flex-column p-3" id="sidebarMenu">
        <button id="closeMenu" class="close-menu-btn">
            <i class="fas fa-times"></i>
        </button>
        </button>
        <div class="logo">
            <img src="images/logo.png" alt="Logo Billie Eilish">
        </div>
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="index.html" class="nav-link"><i class="fas fa-home me-2"></i> Home</a>
            </li>
            <li>
                <a href="favoritos.html" class="nav-link"><i class="fas fa-heart me-2"></i> Favoritos</a>
            </li>
            <li class="d-none" id="btnAdicionarAlbum">
                <a href="addAlbum.html"><i class="fa-solid fa-plus"></i>Adicionar álbum</a>
            </li>
        </ul>
    </nav>

    <main class="content">
        <div id="tela">Carregando...</div>
    </main>

    
        <footer class="bg-black mt-5">
            <div class="container" id="footer-content">
            </div>
        </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="assets/scripts/app.js"></script>

    <script>
        function getUsuarioAtual() {
            const userRaw = localStorage.getItem("usuarioLogado");
            if (!userRaw || userRaw === "undefined") return null;
            try { return JSON.parse(userRaw); } catch (e) { return null; }
        }

        // Função para salvar no JSON Server
        async function salvarAlbum(id, dadosAlbum) {
            try {
                await fetch(`http://localhost:3000/destaque/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosAlbum)
                });
                window.location.reload();
            } catch (error) {
                console.error(error);
                alert("Erro ao salvar alterações.");
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const tela = document.getElementById('tela');
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const usuario = getUsuarioAtual();
            const isAdmin = usuario && usuario.tipo === "admin";

            if (!id) {
                tela.innerHTML = '<p>ID inválido. Verifique o link.</p>';
                return;
            }

            try {
                const resposta = await fetch(`http://localhost:3000/destaque/${id}`);
                if (!resposta.ok) throw new Error("Álbum não encontrado");
                const album = await resposta.json();
                if (!album.faixas) album.faixas = [];

                // Adicionar
                const adicionarFaixaLogica = async (dados) => {
                    const maxId = album.faixas.reduce((max, f) => Math.max(max, Number(f.id)), 0);
                    album.faixas.push({
                        id: maxId + 1,
                        nome: dados.nome,
                        duracao: dados.duracao,
                        streams: dados.streams
                    });
                    await salvarAlbum(album.id, album);
                };

                // Editar
                const editarFaixaLogica = async (trackId, dados) => {
                    const index = album.faixas.findIndex(f => String(f.id) === String(trackId));
                    if (index !== -1) {
                        album.faixas[index] = { ...album.faixas[index], ...dados };
                        await salvarAlbum(album.id, album);
                    }
                };

                // Excluir
                const excluirFaixaLogica = async (trackId) => {
                    if (!confirm("Tem certeza que deseja excluir?")) return;
                    album.faixas = album.faixas.filter(f => String(f.id) !== String(trackId));
                    await salvarAlbum(album.id, album);
                };


                // --- RENDERIZAÇÃO  ---

                tela.innerHTML = `
                            <div class="row g-5"> <div class="col-lg-4">
                                    <div class="sticky-top" style="top: 20px; z-index: 1;">
                                        ${album.imagem ? `<img src="${album.imagem}" alt="${album.album}" class="img-fluid rounded-4 shadow-lg mb-4" style="width:100%; object-fit: cover;">` : ''}
                                        
                                        <div class="album-info">
                                            <h1 class="fw-bold mb-2" style="font-size: 2.5rem;">${album.album}</h1>
                                            <p class="text-secondary mb-3"><i class="bi bi-calendar-event me-2"></i>${album.lancamento}</p>
                                            
                                            <p class="text-light" style="line-height: 1.6; opacity: 0.9;">${album.informacoes}</p>
                                            
                                            <div class="d-grid gap-2 d-md-flex mt-4">
                                                <a href="${album.youtube}" target="_blank" btn-lg flex-grow-1">
                                                    <i class="bi bi-youtube me-2"></i> YouTube
                                                </a>
                                                <a href="${album.spotify}" target="_blank" btn-lg flex-grow-1">
                                                    <i class="bi bi-spotify me-2"></i> Spotify
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-8">
                                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom border-secondary pb-2">
                                        <h2 class="m-0"><i class="bi bi-music-note-list me-2"></i>Faixas</h2>
                                        
                                        ${isAdmin ? `
                                            <button id="toggleAddForm" class="btn btn-outline-light btn-sm rounded-pill px-3">
                                                <i class="bi bi-plus-lg me-1"></i> Nova Faixa
                                            </button>
                                        ` : ''}
                                    </div>

                                    ${isAdmin ? `
                                    <div class="mt-3 mb-4">
                                        <form id="formAddFaixa" class="d-flex flex-column gap-3 d-none bg-dark p-4 rounded-3 border border-secondary shadow">
                                            <h5 id="tituloForm" class="text-white border-bottom border-secondary pb-2 mb-0">Nova Faixa</h5>
                                            
                                            <div class="row g-2">
                                                <div class="col-md-6">
                                                    <input type="text" id="novaFaixaNome" placeholder="Nome da faixa" class="form-control bg-secondary text-white border-0" required>
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="text" id="novaFaixaDuracao" placeholder="Duração (3:45)" class="form-control bg-secondary text-white border-0">
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="text" id="novaFaixaStreams" placeholder="Streams" class="form-control bg-secondary text-white border-0">
                                                </div>
                                            </div>

                                            <div class="d-flex justify-content-end gap-2">
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="btnCancelEdit" style="display:none">Cancelar</button>
                                                <button class="btn btn-primary btn-sm px-4" type="submit" id="btnSubmitFaixa">Salvar</button>
                                            </div>
                                        </form>
                                    </div>
                                    ` : ''}

                                    <ul id="lista-faixas" class="list-group list-group-flush">
                                        ${album.faixas && album.faixas.length
                        ? album.faixas.map((f, index) => `
                                                <li class="list-group-item bg-transparent text-white border-secondary py-3" data-trackid="${f.id}">
                                                    
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div class="d-flex align-items-center flex-grow-1">
                                                            <span class="text-secondary fw-bold me-3" style="min-width: 25px;">${index + 1}</span>
                                                            <div>
                                                                <div class="fw-bold " style="font-size: 1.1rem;">${f.nome}</div>
                                                                <div class="small text-secondary mt-1">
                                                                    <i class="bi bi-clock me-1"></i>${f.duracao || '--:--'} 
                                                                    <span class="mx-2">•</span> 
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        ${isAdmin ? `
                                                        <div class="acoes-track position-relative ms-3">
                                                            <button class="btn btn-dark btn-sm rounded-circle border-secondary menu-track-btn" data-trackid="${f.id}" style="width: 32px; height: 32px;">
                                                                <i class="bi bi-three-dots-vertical"></i>
                                                            </button>
                                                            <div class="menu-opcoes-track bg-dark border border-secondary rounded shadow p-2 d-none" id="menu-track-${f.id}" style="position: absolute; right: 0; top: 100%; z-index: 10; min-width: 140px;">
                                                                <button class="btn btn-warning btn-sm w-100 mb-1 text-start edit-track-btn" data-trackid="${f.id}"><i class="bi bi-pencil me-2"></i>Editar</button>
                                                                <button class="btn btn-danger btn-sm w-100 text-start delete-track-btn" data-trackid="${f.id}"><i class="bi bi-trash me-2"></i>Excluir</button>
                                                            </div>
                                                        </div>
                                                        ` : ''}
                                                    </div>

                                                    ${f.spotify_id ? `
                                                        <div class="mt-3 ms-md-4">
                                                            <iframe style="border-radius:12px" 
                                                                src="https://open.spotify.com/embed/track/${f.spotify_id}?utm_source=generator&theme=0" 
                                                                width="100%" 
                                                                height="80" 
                                                                frameBorder="0" 
                                                                allowfullscreen="" 
                                                                allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                                                                loading="lazy">
                                                            </iframe>
                                                        </div>
                                                    ` : ''}
                                                </li>`
                        ).join('')
                        : '<li class="list-group-item bg-transparent text-white py-4 text-center text-muted">Nenhuma faixa cadastrada neste álbum.</li>'
                    }
                                    </ul>

                                    <div class="mt-5 p-4 bg-dark rounded-4 border border-secondary shadow-sm">
                                        <h4 class="text-light mb-4 border-start border-4 border-warning ps-3">Estatísticas de Streams</h4>
                                        <div style="position: relative; height:350px; width:100%;">
                                            <canvas id="graficoStreams"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;

                if (isAdmin) {
                    const toggleBtn = document.getElementById('toggleAddForm');
                    const formAdd = document.getElementById('formAddFaixa');
                    const btnSubmitFaixa = document.getElementById('btnSubmitFaixa');
                    const btnCancelEdit = document.getElementById('btnCancelEdit');
                    const tituloForm = document.getElementById('tituloForm');

                    // Abrir/Fechar Formulário
                    if (toggleBtn && formAdd) {
                        toggleBtn.addEventListener('click', () => {
                            const hidden = formAdd.classList.contains('d-none');
                            if (hidden) {
                                formAdd.classList.remove('d-none');
                                toggleBtn.textContent = 'Fechar formulário';
                                formAdd.reset();
                                delete formAdd.dataset.editing;
                                tituloForm.textContent = "Nova Faixa";
                                btnSubmitFaixa.textContent = 'Adicionar';
                                btnCancelEdit.style.display = 'none';
                            } else {
                                formAdd.classList.add('d-none');
                                toggleBtn.textContent = '+ Adicionar faixa';
                                formAdd.reset();
                            }
                        });
                    }

                    // Enviar Formulário
                    if (formAdd) {
                        formAdd.addEventListener('submit', async (ev) => {
                            ev.preventDefault();
                            const nome = document.getElementById('novaFaixaNome').value.trim();
                            const duracao = document.getElementById('novaFaixaDuracao').value.trim();
                            const streams = document.getElementById('novaFaixaStreams').value.trim();

                            if (!nome) return alert('Informe o nome da faixa.');

                            const editingId = formAdd.dataset.editing;
                            if (editingId) {
                                await editarFaixaLogica(editingId, { nome, duracao, streams });
                            } else {
                                await adicionarFaixaLogica({ nome, duracao, streams });
                            }
                        });

                        // Cancelar Edição
                        btnCancelEdit.addEventListener('click', () => {
                            delete formAdd.dataset.editing;
                            formAdd.reset();
                            formAdd.classList.add('d-none');
                            toggleBtn.textContent = '+ Adicionar faixa';
                            btnCancelEdit.style.display = 'none';
                        });
                    }

                    // Cliques na lista (Editar/Excluir/Menu)
                    const listaFaixas = document.getElementById('lista-faixas');
                    if (listaFaixas) {
                        listaFaixas.addEventListener('click', async (ev) => {
                            // Menu ...
                            const menuBtn = ev.target.closest('.menu-track-btn');
                            if (menuBtn) {
                                ev.stopPropagation();
                                const idTrack = menuBtn.dataset.trackid;
                                document.querySelectorAll('.menu-opcoes-track').forEach(m => {
                                    if (m.id !== `menu-track-${idTrack}`) m.classList.add('d-none');
                                });
                                const menu = document.getElementById(`menu-track-${idTrack}`);
                                if (menu) menu.classList.toggle('d-none');
                                return;
                            }

                            // Botão Editar (Lápis)
                            const editBtn = ev.target.closest('.edit-track-btn');
                            if (editBtn) {
                                ev.stopPropagation();
                                const trackId = editBtn.dataset.trackid;
                                const track = album.faixas.find(f => String(f.id) === String(trackId));
                                if (track) {
                                    formAdd.classList.remove('d-none');
                                    toggleBtn.textContent = 'Fechar formulário';
                                    document.getElementById('novaFaixaNome').value = track.nome || '';
                                    document.getElementById('novaFaixaDuracao').value = track.duracao || '';
                                    document.getElementById('novaFaixaStreams').value = track.streams || '';

                                    formAdd.dataset.editing = trackId;
                                    tituloForm.textContent = `Editando: ${track.nome}`;
                                    btnSubmitFaixa.textContent = 'Salvar';
                                    btnCancelEdit.style.display = 'inline-block';

                                    const menu = document.getElementById(`menu-track-${trackId}`);
                                    if (menu) menu.classList.add('d-none');
                                }
                                return;
                            }

                            // Botão Excluir (Lixeira)
                            const delBtn = ev.target.closest('.delete-track-btn');
                            if (delBtn) {
                                ev.stopPropagation();
                                const trackId = delBtn.dataset.trackid;
                                await excluirFaixaLogica(trackId);
                            }
                        });
                    }

                    // Fechar menu ao clicar fora
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.acoes-track')) {
                            document.querySelectorAll('.menu-opcoes-track').forEach(m => m.classList.add('d-none'));
                        }
                    });
                } // fim if(isAdmin)

                // --- GRÁFICO (Mantido Original) ---
                const canvas = document.getElementById('graficoStreams');
                if (canvas && album.faixas.length > 0) {
                    const nomes = album.faixas.map(f => f.nome || '—');
                    const valores = album.faixas.map(f => {
                        const s = (f.streams || '').toString().replace(/,/g, '').replace(/\./g, '');
                        const n = parseFloat(s);
                        return isNaN(n) ? 0 : n;
                    });

                    // Verifica se tem dados
                    if (valores.some(v => v > 0)) {
                        new Chart(canvas, {
                            type: 'doughnut',
                            data: {
                                labels: nomes,
                                datasets: [{
                                    label: 'Streams',
                                    data: valores,
                                    backgroundColor: ['#121896', '#040854', '#000CF5', '#020536', '#0E0F2E', '#5475F7'],
                                    borderColor: '#000',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                cutout: '60%',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'right', labels: { color: '#fff', font: { size: 12 } } }
                                }
                            }
                        });
                    } else {
                        canvas.parentElement.innerHTML = '<p class="text-center text-white">Sem dados de streams.</p>';
                    }
                }

            } catch (erro) {
                console.error(erro);
                tela.innerHTML = '<p>Erro ao carregar informações.</p>';
            }
        });
    </script>
</body>

</html>