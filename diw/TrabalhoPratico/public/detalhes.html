<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Detalhes do √Ålbum</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/detalhes.css">
</head>

<body>
    <header class="topbar">
        <button id="menuHamburger" class="hamburger-btn">
            <i class="fas fa-bars"></i>
        </button>

        <div class="actions">
            <div class="actions">
                <a href="login.html" id="btnAuth" class="nav-link btn btn-sm">Login</a>
                <!-- <span id="msgOla" class="text-white ms-2"></span> -->
                <input type="text" id="campoBusca" placeholder="Buscar" oninput="pesquisar()" style="display: none;">
                <button id="btnBusca"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>

        </div>

        <!-- <div class="actions">
            <a href="login.html" id="btnAuth" class="nav-link btn btn-sm">Login</a>
            <button id="btnBusca"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div> -->
    </header>

    <nav class="sidebar d-flex flex-column p-3" id="sidebarMenu">
        <button id="closeMenu" class="close-menu-btn">
            <i class="fas fa-times"></i>
        </button>
        <div class="logo">
            <img src="images/logo.png" alt="Logo Billie Eilish">
        </div>
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="index.html" class="nav-link"><i class="fas fa-home me-2"></i> Home</a>
            </li>
            <li>
                <a href="favoritos.html" class="nav-link"><i class="fas fa-heart me-2"></i> Favoritos</a>
            </li>
            <li>
                <a href="discografia.html" class="nav-link"><i class="fa-solid fa-record-vinyl me-2"></i>
                    Discografia</a>
            </li>
            <li>
                <a href="conectar.html" class="nav-link"><i class="fas fa-users me-2"></i> Conectar</a>
            </li>
            <li class="d-none id="btnAdicionarAlbum">
                <a href="addAlbum.html"><i class="fa-solid fa-plus"></i>Adicionar √°lbum</a>
            </li>
            <li class="bottom">
                <a href="sobre.html"><i class="fas fa-user-circle"></i>Biografia</a>
            </li>
        </ul>
    </nav>

    <main class="content">
        <div id="tela">Carregando...</div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="assets/scripts/app.js"></script>

    <script>
        // --- 1. Fun√ß√µes de Suporte e Seguran√ßa ---
        function getUsuarioAtual() {
            const userRaw = localStorage.getItem("usuarioLogado");
            if (!userRaw || userRaw === "undefined") return null;
            try { return JSON.parse(userRaw); } catch (e) { return null; }
        }

        // Fun√ß√£o para salvar no JSON Server
        async function salvarAlbum(id, dadosAlbum) {
            try {
                await fetch(`http://localhost:3000/destaque/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosAlbum)
                });
                window.location.reload();
            } catch (error) {
                console.error(error);
                alert("Erro ao salvar altera√ß√µes.");
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const tela = document.getElementById('tela');
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');

            // Verifica se √© Admin para esconder/mostrar coisas
            const usuario = getUsuarioAtual();
            const isAdmin = usuario && usuario.tipo === "admin";

            if (!id) {
                tela.innerHTML = '<p>ID inv√°lido. Verifique o link.</p>';
                return;
            }

            try {
                const resposta = await fetch(`http://localhost:3000/destaque/${id}`);
                if (!resposta.ok) throw new Error("√Ålbum n√£o encontrado");
                const album = await resposta.json();
                if (!album.faixas) album.faixas = [];

                // --- Fun√ß√µes de L√≥gica (Adicionar, Editar, Excluir) ---

                // Adicionar
                const adicionarFaixaLogica = async (dados) => {
                    const maxId = album.faixas.reduce((max, f) => Math.max(max, Number(f.id)), 0);
                    album.faixas.push({
                        id: maxId + 1,
                        nome: dados.nome,
                        duracao: dados.duracao,
                        streams: dados.streams
                    });
                    await salvarAlbum(album.id, album);
                };

                // Editar
                const editarFaixaLogica = async (trackId, dados) => {
                    const index = album.faixas.findIndex(f => String(f.id) === String(trackId));
                    if (index !== -1) {
                        album.faixas[index] = { ...album.faixas[index], ...dados };
                        await salvarAlbum(album.id, album);
                    }
                };

                // Excluir
                const excluirFaixaLogica = async (trackId) => {
                    if (!confirm("Tem certeza que deseja excluir?")) return;
                    album.faixas = album.faixas.filter(f => String(f.id) !== String(trackId));
                    await salvarAlbum(album.id, album);
                };


                // --- RENDERIZA√á√ÉO (SEU LAYOUT ORIGINAL) ---
                tela.innerHTML = `
            <div class="album-layout">
                <div class="left-side">
                    ${album.imagem ? `<img src="${album.imagem}" alt="${album.album}" class="album-cover">` : ''}
                    <div class="album-info">
                        <h1>${album.album}</h1>
                        <p><strong>Lan√ßamento:</strong> ${album.lancamento}</p>
                        <p>${album.informacoes}</p>
                        <div class="links">
                            <a href="${album.youtube}" target="_blank" class="yt">
                                <i class="bi bi-youtube"></i> YouTube
                            </a>
                            <a href="${album.spotify}" target="_blank" class="sp">
                                <i class="bi bi-spotify"></i> Spotify
                            </a>
                        </div>
                    </div>
                </div>

                <div class="right-side">
                    <h2>Faixas</h2>
                    <ul id="lista-faixas">
                        ${album.faixas && album.faixas.length
                        ? album.faixas.map(f => `
                                <li data-trackid="${f.id}">
                                    <span>${f.id}. ${f.nome}</span>
                                    <span class="duracao">${f.duracao || ''}</span>
                                    
                                    ${isAdmin ? `
                                    <div class="acoes-track position-relative d-inline-block">
                                        <button class="btn btn-sm btn-dark menu-track-btn" data-trackid="${f.id}">‚ãÆ</button>
                                        <div class="menu-opcoes-track bg-dark border rounded p-2 d-none" id="menu-track-${f.id}">
                                            <button class="btn btn-warning btn-sm w-100 mb-1 edit-track-btn" data-trackid="${f.id}">‚úèÔ∏è Editar</button>
                                            <button class="btn btn-danger btn-sm w-100 delete-track-btn" data-trackid="${f.id}">üóëÔ∏è Excluir</button>
                                        </div>
                                    </div>
                                    ` : ''}
                                </li>`
                        ).join('')
                        : '<li>Nenhuma faixa dispon√≠vel.</li>'
                    }
                    </ul>

                    ${isAdmin ? `
                    <button id="toggleAddForm" class="btn btn-outline-light btn-sm mb-2">+ Adicionar faixa</button>
                    <div class="mt-3">
                        <form id="formAddFaixa" class="d-flex flex-column gap-2 d-none">
                            <h5 id="tituloForm" class="text-white" style="font-size:1rem;">Nova Faixa</h5>
                            <input type="text" id="novaFaixaNome" placeholder="Nome da faixa" class="form-control form-control-sm" required>
                            <input type="text" id="novaFaixaDuracao" placeholder="Dura√ß√£o (ex: 3:45)" class="form-control form-control-sm">
                            <input type="text" id="novaFaixaStreams" placeholder="Streams (opcional)" class="form-control form-control-sm">
                            <div class="d-flex gap-2">
                              <button class="btn btn-primary btn-sm" type="submit" id="btnSubmitFaixa">Adicionar</button>
                              <button type="button" class="btn btn-secondary btn-sm" id="btnCancelEdit" style="display:none">Cancelar</button>
                            </div>
                        </form>
                    </div>
                    ` : ''} </div>
            </div>

            <div class="mt-4 p-3 bg-dark rounded">
                <h4 class="text-center text-light mb-3">Streams</h4>
                <div style="position: relative; height:300px; width:100%;">
                    <canvas id="graficoStreams"></canvas>
                </div>
            </div>
        `;

                // --- EVENT LISTENERS ---

                // S√≥ configura os eventos do formul√°rio se o usu√°rio for Admin (pois os elementos s√≥ existem se for admin)
                if (isAdmin) {
                    const toggleBtn = document.getElementById('toggleAddForm');
                    const formAdd = document.getElementById('formAddFaixa');
                    const btnSubmitFaixa = document.getElementById('btnSubmitFaixa');
                    const btnCancelEdit = document.getElementById('btnCancelEdit');
                    const tituloForm = document.getElementById('tituloForm');

                    // Abrir/Fechar Formul√°rio
                    if (toggleBtn && formAdd) {
                        toggleBtn.addEventListener('click', () => {
                            const hidden = formAdd.classList.contains('d-none');
                            if (hidden) {
                                formAdd.classList.remove('d-none');
                                toggleBtn.textContent = 'Fechar formul√°rio';
                                formAdd.reset();
                                delete formAdd.dataset.editing;
                                tituloForm.textContent = "Nova Faixa";
                                btnSubmitFaixa.textContent = 'Adicionar';
                                btnCancelEdit.style.display = 'none';
                            } else {
                                formAdd.classList.add('d-none');
                                toggleBtn.textContent = '+ Adicionar faixa';
                                formAdd.reset();
                            }
                        });
                    }

                    // Enviar Formul√°rio
                    if (formAdd) {
                        formAdd.addEventListener('submit', async (ev) => {
                            ev.preventDefault();
                            const nome = document.getElementById('novaFaixaNome').value.trim();
                            const duracao = document.getElementById('novaFaixaDuracao').value.trim();
                            const streams = document.getElementById('novaFaixaStreams').value.trim();

                            if (!nome) return alert('Informe o nome da faixa.');

                            const editingId = formAdd.dataset.editing;
                            if (editingId) {
                                await editarFaixaLogica(editingId, { nome, duracao, streams });
                            } else {
                                await adicionarFaixaLogica({ nome, duracao, streams });
                            }
                        });

                        // Cancelar Edi√ß√£o
                        btnCancelEdit.addEventListener('click', () => {
                            delete formAdd.dataset.editing;
                            formAdd.reset();
                            formAdd.classList.add('d-none');
                            toggleBtn.textContent = '+ Adicionar faixa';
                            btnCancelEdit.style.display = 'none';
                        });
                    }

                    // Cliques na lista (Editar/Excluir/Menu)
                    const listaFaixas = document.getElementById('lista-faixas');
                    if (listaFaixas) {
                        listaFaixas.addEventListener('click', async (ev) => {
                            // Menu ...
                            const menuBtn = ev.target.closest('.menu-track-btn');
                            if (menuBtn) {
                                ev.stopPropagation();
                                const idTrack = menuBtn.dataset.trackid;
                                document.querySelectorAll('.menu-opcoes-track').forEach(m => {
                                    if (m.id !== `menu-track-${idTrack}`) m.classList.add('d-none');
                                });
                                const menu = document.getElementById(`menu-track-${idTrack}`);
                                if (menu) menu.classList.toggle('d-none');
                                return;
                            }

                            // Bot√£o Editar (L√°pis)
                            const editBtn = ev.target.closest('.edit-track-btn');
                            if (editBtn) {
                                ev.stopPropagation();
                                const trackId = editBtn.dataset.trackid;
                                const track = album.faixas.find(f => String(f.id) === String(trackId));
                                if (track) {
                                    formAdd.classList.remove('d-none');
                                    toggleBtn.textContent = 'Fechar formul√°rio';
                                    document.getElementById('novaFaixaNome').value = track.nome || '';
                                    document.getElementById('novaFaixaDuracao').value = track.duracao || '';
                                    document.getElementById('novaFaixaStreams').value = track.streams || '';

                                    formAdd.dataset.editing = trackId;
                                    tituloForm.textContent = `Editando: ${track.nome}`;
                                    btnSubmitFaixa.textContent = 'Salvar';
                                    btnCancelEdit.style.display = 'inline-block';

                                    const menu = document.getElementById(`menu-track-${trackId}`);
                                    if (menu) menu.classList.add('d-none');
                                }
                                return;
                            }

                            // Bot√£o Excluir (Lixeira)
                            const delBtn = ev.target.closest('.delete-track-btn');
                            if (delBtn) {
                                ev.stopPropagation();
                                const trackId = delBtn.dataset.trackid;
                                await excluirFaixaLogica(trackId);
                            }
                        });
                    }

                    // Fechar menu ao clicar fora
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.acoes-track')) {
                            document.querySelectorAll('.menu-opcoes-track').forEach(m => m.classList.add('d-none'));
                        }
                    });
                } // fim if(isAdmin)

                // --- GR√ÅFICO (Mantido Original) ---
                const canvas = document.getElementById('graficoStreams');
                if (canvas && album.faixas.length > 0) {
                    const nomes = album.faixas.map(f => f.nome || '‚Äî');
                    const valores = album.faixas.map(f => {
                        const s = (f.streams || '').toString().replace(/,/g, '').replace(/\./g, '');
                        const n = parseFloat(s);
                        return isNaN(n) ? 0 : n;
                    });

                    // Verifica se tem dados
                    if (valores.some(v => v > 0)) {
                        new Chart(canvas, {
                            type: 'doughnut',
                            data: {
                                labels: nomes,
                                datasets: [{
                                    label: 'Streams',
                                    data: valores,
                                    backgroundColor: ['#121896', '#040854', '#000CF5', '#020536', '#0E0F2E', '#5475F7'],
                                    borderColor: '#000',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                cutout: '60%',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'right', labels: { color: '#fff', font: { size: 12 } } }
                                }
                            }
                        });
                    } else {
                        canvas.parentElement.innerHTML = '<p class="text-center text-white">Sem dados de streams.</p>';
                    }
                }

            } catch (erro) {
                console.error(erro);
                tela.innerHTML = '<p>Erro ao carregar informa√ß√µes.</p>';
            }
        });
    </script>
</body>

</html>